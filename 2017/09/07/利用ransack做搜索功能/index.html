<!DOCTYPE html><html><head><meta charset="utf-8"><meta name="X-UA-Compatible" content="IE=edge"><title> åˆ©ç”¨ransackåšæœç´¢åŠŸèƒ½ Â· æ­ªè„–å­é¹…çš„åšå®¢</title><meta name="description" content="åˆ©ç”¨ransackåšæœç´¢åŠŸèƒ½ - æ­ªè„–å­é¹…"><meta name="viewport" content="width=device-width, initial-scale=1"><link rel="icon" href="/favicon.jpeg"><link rel="stylesheet" href="/css/apollo.css"><link rel="search" type="application/opensearchdescription+xml" href="http://yoursite.com/atom.xml" title="æ­ªè„–å­é¹…çš„åšå®¢"></head><body><div class="wrap"><header><a href="/" class="logo-link"><img src="/favicon.jpeg" alt="logo"></a><ul class="nav nav-list"><li class="nav-list-item"><a href="/" target="_self" class="nav-list-link">BLOG</a></li><li class="nav-list-item"><a href="/archives/" target="_self" class="nav-list-link">ARCHIVE</a></li><li class="nav-list-item"><a href="https://github.com/zpf0918" target="_blank" class="nav-list-link">GITHUB</a></li></ul></header><main class="container"><div class="post"><article class="post-block"><h1 class="post-title">åˆ©ç”¨ransackåšæœç´¢åŠŸèƒ½</h1><div class="post-info">Sep 7, 2017</div><div class="post-content"><p>æœ¬ç¯‡æ•™ç¨‹åŸºäºè‡ªå·±çš„ä¸€ä¸ªå°é¡¹ç›®ï¼Œç”¨æˆ·å¯ä»¥æœç´¢ç½‘ç«™ä¸Šå…¶ä»–ç”¨æˆ·å‘è¡¨è¿‡çš„æ–‡ç« ã€‚</p>
<h3 id="ç¬¬ä¸€æ­©ï¼š"><a href="#ç¬¬ä¸€æ­©ï¼š" class="headerlink" title="ç¬¬ä¸€æ­©ï¼š"></a>ç¬¬ä¸€æ­©ï¼š</h3><p><strong>å®‰è£…gem ransack</strong></p>
<blockquote>
<p>ransackä¼šç”¨æ•°æ®åº“çš„LIKEè¯­æ³•æ¥åšæœå¯»ï¼Œè™½ç„¶æ¯”è¾ƒæ–¹ä¾¿ï¼Œä½†å®ƒä¼šä¾æ¬¡æ£€æŸ¥èµ„æ–™æ˜¯å¦ç¬¦åˆï¼Œè€Œä¸ä¼šä½¿ç”¨æ•°æ®åº“çš„ç´¢å¼•ã€‚å¦‚æœæ•°æ®æ¯”è¾ƒåºå¤§çš„è¯ï¼Œåˆ©ç”¨ransackå°†ä¸ä¼šæ˜¯ä¸€ä¸ªå¥½çš„é€‰æ‹©ã€‚è¿™æ—¶å€™æˆ‘ä»¬å°±å¯ä»¥å®‰è£…ä¸“é—¨çš„å…¨æ–‡æœç´¢å¼•æ“ï¼Œä¾‹å¦‚<a href="https://www.elastic.co/cn/" target="_blank" rel="external">Elasticsearch</a></p>
</blockquote>
<figure class="highlight ruby"><figcaption><span>Gemfile</span></figcaption><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">+  gem <span class="string">'ransack'</span></div></pre></td></tr></table></figure>
<p><code>$ bundle</code>ï¼Œé‡å¯ rails s</p>
<h3 id="ç¬¬äºŒæ­©"><a href="#ç¬¬äºŒæ­©" class="headerlink" title="ç¬¬äºŒæ­©"></a>ç¬¬äºŒæ­©</h3><p><strong>controllerä¸configçš„è®¾å®š</strong><br>1ã€è®¾ç½®è·¯ç”±<br><figure class="highlight ruby"><figcaption><span>config/routes.rb</span></figcaption><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div></pre></td><td class="code"><pre><div class="line">Rails.application.routes.draw <span class="keyword">do</span></div><div class="line">  devise_for <span class="symbol">:users</span></div><div class="line">  resources <span class="symbol">:posts</span> <span class="keyword">do</span></div><div class="line"> +   collection <span class="keyword">do</span>    <span class="comment">#æˆ‘ä»¬ä¼šæœç´¢å‡ºæ‰€æœ‰ç¬¦åˆå…³é”®å­—çš„æ–‡ç« ï¼Œç»“æœä¸ºå¤æ•°ï¼Œå› æ­¤ç”¨collectionï¼Œè€Œä¸æ˜¯member</span></div><div class="line"> +     get <span class="symbol">:search</span></div><div class="line"> +   <span class="keyword">end</span></div><div class="line">  <span class="keyword">end</span></div><div class="line"><span class="keyword">end</span>  </div><div class="line"><span class="string">``</span><span class="string">`  </span></div><div class="line"><span class="string">2ã€ è®¾ç½®controller</span></div><div class="line"><span class="string">ä¸»è¦è®¾ç½®é€šè¿‡å“ªäº›å…³é”®è¯è¿›è¡Œæœç´¢ã€‚</span></div><div class="line"><span class="string">`</span><span class="string">``</span>ruby app/controllers/posts_controller.rb</div><div class="line">  <span class="class"><span class="keyword">class</span> <span class="title">PostsController</span> &lt; ApplicationController</span></div><div class="line">    before_action <span class="symbol">:validate_search_key</span>, <span class="symbol">only:</span> [<span class="symbol">:search</span>]</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">search</span></span></div><div class="line">      <span class="keyword">if</span> @query_string.present?</div><div class="line">        @posts = search_params    <span class="comment">#æœç´¢postçš„å…³é”®è¯</span></div><div class="line">      <span class="keyword">end</span></div><div class="line">    <span class="keyword">end</span></div><div class="line"></div><div class="line">    protected  <span class="comment"># æ”¾åœ¨æœ€å</span></div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">validate_search_key</span></span></div><div class="line">       <span class="comment"># gsub æ˜¯Rubyä¸­æ­£åˆ™è¡¨è¾¾å¼çš„æ–¹æ³•ï¼Œå®ƒä¼šåˆ‡æ¢æ‰€æœ‰åŒ¹é…åˆ°çš„éƒ¨åˆ†</span></div><div class="line">       @query_string = params[<span class="symbol">:q</span>].gsub(<span class="regexp">/\\|\'|\/|\?/</span>, <span class="string">""</span>)<span class="keyword">if</span> params[<span class="symbol">:q</span>].present?  </div><div class="line">    <span class="keyword">end</span></div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">search_params</span>      </span></div><div class="line">      Post.ransack(&#123;<span class="symbol">:title_or_content_cont</span> =&gt; @query_string&#125;).result(<span class="symbol">distinct:</span> <span class="literal">true</span>)</div><div class="line">      <span class="comment">#titleä¸contentæ˜¯postçš„ä¸¤ä¸ªæ ä½ï¼Œè€Œæˆ‘ä»¬çš„å…³é”®è¯å‡ºè‡ªè¿™é‡Œ</span></div><div class="line">      <span class="keyword">end</span></div><div class="line">  <span class="keyword">end</span></div></pre></td></tr></table></figure></p>
<h3 id="ç¬¬ä¸‰æ­©"><a href="#ç¬¬ä¸‰æ­©" class="headerlink" title="ç¬¬ä¸‰æ­©"></a>ç¬¬ä¸‰æ­©</h3><p><strong>viewsçš„è®¾å®š</strong><br>1ã€å¯¼èˆªæ çš„æ˜¾ç¤º<br><figure class="highlight ruby"><figcaption><span>app/views/common/_navbar.html.erb</span></figcaption><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line"> &lt;div class="collapse navbar-collapse" id="bs-example-navbar-collapse-1"&gt;</div><div class="line"> +  &lt;ul class="nav navbar-nav"&gt;</div><div class="line"> +    &lt;li&gt;</div><div class="line"> +        &lt;div class="form-group form-inline search-bar"&gt;</div><div class="line"> +          &lt;%= render <span class="symbol">:partial</span> =&gt; <span class="string">"posts/search_bar"</span>%&gt;</div><div class="line"> +       &lt;<span class="regexp">/div&gt;</span></div><div class="line"><span class="regexp"> +      &lt;/li</span>&gt;</div><div class="line"> +  &lt;<span class="regexp">/ul&gt;</span></div><div class="line"><span class="regexp"> â€¦â€¦ ç•¥</span></div><div class="line"><span class="regexp">&lt;/div</span>&gt;</div></pre></td></tr></table></figure></p>
<p>æ‰§è¡Œ<code>$ touch app/views/posts/_search_bar.html.erb</code>,å¹¶ç¼–è¾‘<br><figure class="highlight ruby"><figcaption><span>app/views/posts/_search_bar.html.erb</span></figcaption><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line"> &lt;div class="row"&gt;</div><div class="line">  &lt;div class="col-sm-9 col-lg-8 col-lg-offset-2"&gt;</div><div class="line">    &lt;%= form_tag search_posts_path, <span class="symbol">:class</span> =&gt; <span class="string">"posts-search-form"</span>, <span class="symbol">:method</span> =&gt; <span class="symbol">:get</span> <span class="keyword">do</span> %&gt;</div><div class="line">      &lt;div class="input-group"&gt;</div><div class="line">        &lt;input type="text" class="form-control search-bar-input" name="q" value="&lt;%= params[:q] %&gt;" placeholder="å…³é”®è¯"&gt;</div><div class="line">        &lt;span class="input-group-btn"&gt;</div><div class="line">          &lt;button type="submit" class="btn btn-default search-bar-submit"&gt;</div><div class="line">            &lt;span class="glyphicon glyphicon-search"&gt;&lt;/span&gt;</div><div class="line">          &lt;<span class="regexp">/button&gt;</span></div><div class="line"><span class="regexp">        &lt;/span</span>&gt;</div><div class="line">      &lt;<span class="regexp">/div&gt;</span></div><div class="line"><span class="regexp">    &lt;% end %&gt;</span></div><div class="line"><span class="regexp">  &lt;/div</span>&gt;</div><div class="line">&lt;<span class="regexp">/div&gt;</span></div></pre></td></tr></table></figure></p>
<p><strong>2.æœç´¢åé¦ˆé¡µé¢</strong><br>æ–°å¢ <code>app/views/posts/search.html.erb</code><br><figure class="highlight ruby"><figcaption><span>app/views/posts/search.html.erb</span></figcaption><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div></pre></td><td class="code"><pre><div class="line">&lt;div class="minHeight1000 bg-gray"&gt;</div><div class="line">  &lt;div class="search-page w1200 pt30 bc"&gt;</div><div class="line">      &lt;% <span class="keyword">if</span> @posts.present? %&gt;</div><div class="line">        &lt;h5 class="collection search-count"&gt;å·²ä¸ºæ‚¨æ‰¾åˆ°&lt;%= @posts.count %&gt;ç¯‡ç›¸å…³æ–‡ç« &lt;/h5&gt;</div><div class="line">      &lt;% <span class="keyword">else</span> %&gt;</div><div class="line">        &lt;p class="tc mt100"&gt;æœªæœç´¢åˆ°ä»»ä½•æ–‡ç« ï¼Œè¦ä¸æ¢ä¸ªå…³é”®è¯è¯•è¯•ï¼Ÿ&lt;/p&gt;</div><div class="line">      &lt;% <span class="keyword">end</span> %&gt;</div><div class="line">  &lt;<span class="regexp">/div&gt;</span></div><div class="line"><span class="regexp"></span></div><div class="line"><span class="regexp">  &lt;div class="container"&gt;</span></div><div class="line"><span class="regexp">  &lt;% @posts.each do |post| %&gt;</span></div><div class="line"><span class="regexp"></span></div><div class="line"><span class="regexp">    &lt;div class="panel panel-default"&gt;</span></div><div class="line"><span class="regexp">      &lt;div class="panel-body"&gt;</span></div><div class="line"><span class="regexp">        &lt;%= post.title %&gt;</span></div><div class="line"><span class="regexp">        &lt;br/</span>&gt;</div><div class="line">        &lt;br/&gt;</div><div class="line">        &lt;span id="psot-thumbsup-&lt;%= post.id%&gt;" class=" label label-success"&gt;&lt;%= post.likes.count%&gt;ğŸ‘&lt;/span&gt;</div><div class="line">        &lt;div class="text-right"&gt;</div><div class="line"></div><div class="line">          &lt;% <span class="keyword">if</span> !current_user.is_collect_of?(post) %&gt;</div><div class="line">            &lt;%= link_to(<span class="string">"æ”¶è—"</span>, collect_post_path(post), <span class="symbol">method:</span> <span class="symbol">:post</span>, <span class="class"><span class="keyword">class</span>: "<span class="title">btn</span> <span class="title">btn</span>-<span class="title">sm</span>") %&gt;</span></div><div class="line">          &lt;% <span class="keyword">else</span> %&gt;</div><div class="line">            &lt;%= link_to(<span class="string">"å–æ¶ˆæ”¶è—"</span>, uncollect_post_path(post), <span class="symbol">method:</span> <span class="symbol">:post</span>, <span class="class"><span class="keyword">class</span>: "<span class="title">btn</span> <span class="title">btn</span>-<span class="title">sm</span>") %&gt;</span></div><div class="line">          &lt;% <span class="keyword">end</span> %&gt;</div><div class="line">        &lt;<span class="regexp">/div&gt;</span></div><div class="line"><span class="regexp">      &lt;/div</span>&gt;</div><div class="line"></div><div class="line">    &lt;<span class="regexp">/div&gt;</span></div><div class="line"><span class="regexp"></span></div><div class="line"><span class="regexp">  &lt;% end %&gt;</span></div><div class="line"><span class="regexp">  &lt;/div</span>&gt;</div><div class="line">&lt;<span class="regexp">/div&gt;</span></div></pre></td></tr></table></figure></p>
<p>æ•ˆæœå›¾<br>   <img src="https://ws3.sinaimg.cn/large/006tNc79gy1fhcsoezlm4j31bw0g9gmw.jpg" alt=""></p>
</div></article></div></main><footer><div class="paginator"><a href="/2017/09/07/ä¸¤ç§æ–¹æ³•å®ç°æ”¶è—æˆ–è€…ç‚¹èµåŠŸèƒ½/" class="prev">ä¸Šä¸€ç¯‡</a><a href="/2017/09/06/my-first-post/" class="next">ä¸‹ä¸€ç¯‡</a></div><div id="disqus_thread"></div><script>var disqus_shortname = 'true';
var disqus_identifier = '2017/09/07/åˆ©ç”¨ransackåšæœç´¢åŠŸèƒ½/';
var disqus_title = 'åˆ©ç”¨ransackåšæœç´¢åŠŸèƒ½';
var disqus_url = 'http://yoursite.com/2017/09/07/åˆ©ç”¨ransackåšæœç´¢åŠŸèƒ½/';
(function() {
    var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
    dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
    (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
})();</script><script id="dsq-count-scr" src="//true.disqus.com/count.js" async></script><div class="copyright"><p>Â© 2017 <a href="http://yoursite.com">æ­ªè„–å­é¹…</a>, powered by <a href="https://hexo.io/" target="_blank">Hexo</a> and <a href="https://github.com/pinggod/hexo-theme-apollo" target="_blank">hexo-theme-apollo</a>.</p></div></footer></div><script async src="//cdn.bootcss.com/mathjax/2.7.0/MathJax.js?config=TeX-MML-AM_CHTML" integrity="sha384-crwIf/BuaWM9rM65iM+dWFldgQ1Un8jWZMuh3puxb8TOY9+linwLoI7ZHZT+aekW" crossorigin="anonymous"></script><script>(function(b,o,i,l,e,r){b.GoogleAnalyticsObject=l;b[l]||(b[l]=function(){(b[l].q=b[l].q||[]).push(arguments)});b[l].l=+new Date;e=o.createElement(i);r=o.getElementsByTagName(i)[0];e.src='//www.google-analytics.com/analytics.js';r.parentNode.insertBefore(e,r)}(window,document,'script','ga'));ga('create',"UA-65933410-1",'auto');ga('send','pageview');</script></body></html>